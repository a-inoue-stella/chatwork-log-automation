<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <style>
    body { padding: 15px; font-family: 'Google Sans', Roboto, Arial, sans-serif; color: #333; }
    .section { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #eee; }
    .section-title { font-weight: bold; font-size: 13px; color: #202124; margin-bottom: 12px; display: flex; align-items: center; }
    
    /* å…¥åŠ›ãƒ»ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    input[type="text"], input[type="password"] { width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; margin-bottom: 8px; }
    button { cursor: pointer; font-weight: 500; border: none; border-radius: 4px; padding: 8px 16px; font-size: 12px; }
    
    /* ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆç™½èƒŒæ™¯ãƒ»é’æ–‡å­—ãƒ»æ ç·šã‚ã‚Šï¼‰ */
    .btn-secondary { background-color: #fff; border: 1px solid #dadce0; color: #1a73e8; margin-top: 8px; width: 100%; }
    .btn-secondary:hover { background-color: #f8f9fa; }
    .btn-secondary:active { background-color: #e8f0fe; }
    
    .btn-danger { color: #d93025; background: none; padding: 4px; font-size: 16px; float: right; }

    /* ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆ */
    .room-item { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e8eaed; }
    .room-label { font-size: 10px; color: #5f6368; font-weight: bold; }
    .room-value { font-size: 12px; color: #3c4043; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* è‡ªå‹•å®Ÿè¡Œã‚¹ã‚¤ãƒƒãƒã‚¨ãƒªã‚¢ */
    .auto-switch-area { background-color: #e8f0fe; padding: 15px; border-radius: 8px; border: 1px solid #d2e3fc; }
    .switch-label { font-weight: bold; color: #174ea6; font-size: 12px; display: flex; align-items: center; }
    .switch-desc { font-size: 11px; color: #1967d2; margin-top: 5px; line-height: 1.4; }
    
    .status-msg { font-size: 11px; color: #137333; margin-top: 6px; height: 16px; text-align: center; }
  </style>
</head>
<body>

  <div class="section">
    <div class="section-title">ğŸ” APIè¨­å®š</div>
    <input type="password" id="apiToken" placeholder="Chatwork API Token">
    <button class="btn-secondary" onclick="saveToken()">è¨­å®šã‚’ä¿å­˜</button>
    <div id="tokenStatus" class="status-msg"></div>
  </div>

  <div class="section">
    <div class="section-title">ğŸ“ ç›£è¦–ãƒ«ãƒ¼ãƒ ç®¡ç†</div>
    <div id="roomList"></div>
    
    <div style="background: #fff; border: 1px dashed #ccc; padding: 10px; border-radius: 4px; margin-top: 10px;">
      <input type="text" id="newRoomId" placeholder="ãƒ«ãƒ¼ãƒ ID ã¾ãŸã¯ URL (ä¾‹: https://.../#!rid123456)">
      <input type="text" id="newTabName" placeholder="ä¿å­˜å…ˆã‚¿ãƒ–å (ä¾‹: Aæ¡ˆä»¶)">
      <button class="btn-secondary" style="font-weight: bold;" onclick="addRoom()">â†“ ãƒªã‚¹ãƒˆã«ç™»éŒ²</button>
    </div>
    
    <button class="btn-secondary" style="margin-top: 12px; font-weight: bold;" onclick="saveRooms()">å¤‰æ›´ã‚’åæ˜ ã™ã‚‹</button>
    <div id="roomStatus" class="status-msg"></div>
  </div>

  <div class="section">
    <div class="section-title">â° è‡ªå‹•åé›†è¨­å®š</div>
    
    <div class="auto-switch-area">
      <div class="switch-label">
        <input type="checkbox" id="autoTriggerSwitch" onchange="toggleTrigger()">
        <label for="autoTriggerSwitch" style="margin-left: 8px; cursor: pointer;">è‡ªå‹•åé›†ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
      </div>
      <div class="switch-desc">
        ONã«ã™ã‚‹ã¨ã€æ¥­å‹™æ™‚é–“ã«é–¢ã‚ã‚‰ãš <strong>10åˆ†é–“éš”</strong> ã§æœ€æ–°ãƒ­ã‚°ã‚’å–å¾—ã—ç¶šã‘ã¾ã™ã€‚å–ã‚Šã“ã¼ã—ã‚’é˜²ãæ¨å¥¨è¨­å®šã§ã™ã€‚
      </div>
    </div>
    <div id="triggerStatus" class="status-msg"></div>
  </div>

  <div class="section" style="border-bottom: none;">
    <div class="section-title">âš¡ æ‰‹å‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
    <button class="btn-secondary" onclick="runManual()">ä»Šã™ãåŒæœŸã‚’å®Ÿè¡Œ</button>
    <div id="runStatus" class="status-msg"></div>
  </div>

  <script>
    // åˆæœŸåŒ–
    window.onload = function() {
      google.script.run.withSuccessHandler(initUi).getSettings();
    };

    function initUi(settings) {
      if(settings.token) {
        document.getElementById('apiToken').value = settings.token;
        document.getElementById('tokenStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
      }
      if(settings.rooms) renderRooms(settings.rooms);
      
      // ãƒˆãƒªã‚¬ãƒ¼çŠ¶æ…‹ã®åæ˜ 
      document.getElementById('autoTriggerSwitch').checked = settings.isTriggerActive;
    }

    // --- ãƒˆãƒªã‚¬ãƒ¼åˆ¶å¾¡ ---
    function toggleTrigger() {
      const isChecked = document.getElementById('autoTriggerSwitch').checked;
      const statusEl = document.getElementById('triggerStatus');
      statusEl.textContent = 'è¨­å®šã‚’æ›´æ–°ä¸­...';
      
      google.script.run.withSuccessHandler((msg) => {
        statusEl.textContent = msg;
      }).updateTrigger(isChecked);
    }

    // --- ãƒ«ãƒ¼ãƒ ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ ---
    let currentRooms = [];

    // URLã‹ã‚‰IDã‚’æŠœãå‡ºã™ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function parseRoomId(input) {
      if (!input) return null;
      const str = input.toString().trim();

      // ãƒ‘ã‚¿ãƒ¼ãƒ³A: æ•°å­—ã®ã¿
      if (/^\d+$/.test(str)) {
        return str;
      }

      // ãƒ‘ã‚¿ãƒ¼ãƒ³B: Chatworkã®URLå½¢å¼
      const match = str.match(/rid(\d+)/);
      if (match && match[1]) {
        return match[1];
      }

      return null;
    }

    // å…¥åŠ›å€¤ã‚’è§£æã—ã¦ã‹ã‚‰ç™»éŒ²ã™ã‚‹
    function addRoom() {
      const rawInput = document.getElementById('newRoomId').value;
      const tab = document.getElementById('newTabName').value;

      // IDæŠ½å‡º
      const validId = parseRoomId(rawInput);

      if (!validId) {
        if (!rawInput) return; // ç©ºãªã‚‰ä½•ã‚‚ã—ãªã„
        alert('ãƒ«ãƒ¼ãƒ IDå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\næ•°å­—ã®ã¿ã€ã¾ãŸã¯Chatworkã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      if (!tab) {
        alert('ä¿å­˜å…ˆã®ã€Œã‚¿ãƒ–åã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      currentRooms.push({ id: validId, tabName: tab });
      renderRooms(currentRooms);
      
      // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
      document.getElementById('newRoomId').value = '';
      document.getElementById('newTabName').value = '';
    }

    function removeRoom(index) {
      currentRooms.splice(index, 1);
      renderRooms(currentRooms);
    }

    function renderRooms(rooms) {
      currentRooms = rooms;
      const container = document.getElementById('roomList');
      container.innerHTML = '';
      rooms.forEach((room, index) => {
        const div = document.createElement('div');
        div.className = 'room-item';
        div.innerHTML = `
          <button class="btn-danger" onclick="removeRoom(${index})">Ã—</button>
          <div class="room-label">ROOM ID</div>
          <div class="room-value">${room.id}</div>
          <div class="room-label">TAB NAME</div>
          <div class="room-value">${room.tabName}</div>
        `;
        container.appendChild(div);
      });
    }

    // ä¿å­˜æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ (ç™»éŒ²å¿˜ã‚Œé˜²æ­¢)
    function saveRooms() {
      // 1. å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«ã€Œæ›¸ãã‹ã‘ã€ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
      const pendingId = document.getElementById('newRoomId').value.trim();
      const pendingTab = document.getElementById('newTabName').value.trim();
      
      if (pendingId || pendingTab) {
        alert('å…¥åŠ›ä¸­ã®ãƒ«ãƒ¼ãƒ æƒ…å ±ãŒã‚ã‚Šã¾ã™ã€‚\nå…ˆã«ã€Œâ†“ ãƒªã‚¹ãƒˆã«ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
        return; 
      }

      // 2. ä¿å­˜å®Ÿè¡Œ
      const saveBtn = document.querySelector('button[onclick="saveRooms()"]');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'ä¿å­˜ä¸­...';
      saveBtn.disabled = true;

      google.script.run.withSuccessHandler(() => {
        showStatus('roomStatus', 'åæ˜ ã—ã¾ã—ãŸ');
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }).saveRoomSettings(currentRooms);
    }

    function saveToken() {
      const val = document.getElementById('apiToken').value;
      google.script.run.withSuccessHandler(() => showStatus('tokenStatus', 'ä¿å­˜ã—ã¾ã—ãŸ')).saveApiToken(val);
    }

    function runManual() {
      document.getElementById('runStatus').textContent = 'å®Ÿè¡Œä¸­...';
      google.script.run.withSuccessHandler((res) => {
        document.getElementById('runStatus').textContent = res;
      }).runFromSidebar();
    }

    function showStatus(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      setTimeout(() => el.textContent = '', 3000);
    }
  </script>
</body>
</html>