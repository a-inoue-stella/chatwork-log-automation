<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <style>
    body { padding: 15px; font-family: 'Google Sans', Roboto, Arial, sans-serif; color: #333; }
    .section { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #eee; }
    .section-title { font-weight: bold; font-size: 13px; color: #202124; margin-bottom: 12px; display: flex; align-items: center; }
    .section-title span { margin-left: 6px; }
    
    /* å…¥åŠ›ãƒ»ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    input[type="text"], input[type="password"] { width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; margin-bottom: 8px; }
    button { cursor: pointer; font-weight: 500; border: none; border-radius: 4px; padding: 8px 16px; font-size: 12px; }
    .btn-primary { background-color: #1a73e8; color: white; width: 100%; }
    .btn-primary:hover { background-color: #1557b0; box-shadow: 0 1px 2px rgba(60,64,67,0.3); }
    .btn-secondary { background-color: #fff; border: 1px solid #dadce0; color: #1a73e8; margin-top: 8px; width: 100%; }
    .btn-danger { color: #d93025; background: none; padding: 4px; font-size: 16px; float: right; }

    /* ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆ */
    .room-item { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e8eaed; }
    .room-label { font-size: 10px; color: #5f6368; font-weight: bold; }
    .room-value { font-size: 12px; color: #3c4043; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆä»Šå›ã®è¿½åŠ ç®‡æ‰€ï¼‰ */
    .schedule-opt { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; }
    .schedule-opt:last-child { border-bottom: none; }
    .schedule-label { margin-left: 10px; font-size: 12px; }
    .schedule-time { margin-left: auto; font-size: 11px; color: #5f6368; background: #f1f3f4; padding: 2px 6px; border-radius: 10px; }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
    .status-msg { font-size: 11px; color: #137333; margin-top: 6px; height: 16px; text-align: center; }
  </style>
</head>
<body>

  <div class="section">
    <div class="section-title">ğŸ” APIè¨­å®š</div>
    <input type="password" id="apiToken" placeholder="Chatwork API Token">
    <button class="btn-secondary" onclick="saveToken()">è¨­å®šã‚’ä¿å­˜</button>
    <div id="tokenStatus" class="status-msg"></div>
  </div>

  <div class="section">
    <div class="section-title">ğŸ“ ç›£è¦–ãƒ«ãƒ¼ãƒ ç®¡ç†</div>
    <div id="roomList"></div>
    
    <div style="background: #fff; border: 1px dashed #ccc; padding: 10px; border-radius: 4px; margin-top: 10px;">
      <input type="text" id="newRoomId" placeholder="ãƒ«ãƒ¼ãƒ ID (ä¾‹: 123456)">
      <input type="text" id="newTabName" placeholder="ä¿å­˜å…ˆã‚¿ãƒ–å (ä¾‹: Aæ¡ˆä»¶)">
      <button class="btn-secondary" style="background:#f1f3f4; border:none; color:#333;" onclick="addRoom()">ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
    </div>
    
    <button class="btn-primary" style="margin-top: 12px;" onclick="saveRooms()">å¤‰æ›´ã‚’åæ˜ ã™ã‚‹</button>
    <div id="roomStatus" class="status-msg"></div>
  </div>

  <div class="section">
    <div class="section-title">â° è‡ªå‹•å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
    <div style="margin-bottom: 10px; font-size: 11px; color: #666;">
      ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚ŒãŸæ™‚é–“ã«ã€è‡ªå‹•ã§ãƒ­ã‚°ã‚’å–å¾—ãƒ»æ•´å½¢ã—ã¦è¿½è¨˜ã—ã¾ã™ã€‚
    </div>

    <div class="schedule-opt">
      <input type="checkbox" id="scheduleMorning" checked>
      <label for="scheduleMorning" class="schedule-label">æœã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯</label>
      <span class="schedule-time">09:00 ã€œ 10:00</span>
    </div>

    <div class="schedule-opt">
      <input type="checkbox" id="scheduleNoon">
      <label for="scheduleNoon" class="schedule-label">æ˜¼ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯</label>
      <span class="schedule-time">12:00 ã€œ 13:00</span>
    </div>

    <div class="schedule-opt">
      <input type="checkbox" id="scheduleEvening" checked>
      <label for="scheduleEvening" class="schedule-label">å¤•æ–¹ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯</label>
      <span class="schedule-time">17:00 ã€œ 18:00</span>
    </div>

    <button class="btn-secondary" onclick="saveSchedule()">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜</button>
    <div id="scheduleStatus" class="status-msg"></div>
  </div>

  <div class="section" style="border-bottom: none;">
    <div class="section-title">âš¡ æ‰‹å‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
    <button class="btn-primary" style="background-color: #188038;" onclick="runManual()">ä»Šã™ãåŒæœŸã‚’å®Ÿè¡Œ</button>
    <div id="runStatus" class="status-msg"></div>
  </div>

  <script>
    // --- åˆæœŸåŒ–ã¨æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
    window.onload = function() {
      google.script.run.withSuccessHandler(initUi).getSettings();
    };

    function initUi(settings) {
      if(settings.token) {
        document.getElementById('apiToken').value = settings.token;
        document.getElementById('tokenStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
      }
      if(settings.rooms) renderRooms(settings.rooms);
      
      // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šã®èª­ã¿è¾¼ã¿ï¼ˆãƒ¢ãƒƒã‚¯ç”¨ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
      if(settings.schedule) {
        document.getElementById('scheduleMorning').checked = settings.schedule.morning;
        document.getElementById('scheduleNoon').checked = settings.schedule.noon;
        document.getElementById('scheduleEvening').checked = settings.schedule.evening;
      }
    }

    // ãƒ«ãƒ¼ãƒ ãƒªã‚¹ãƒˆæ“ä½œ
    let currentRooms = [];
    function renderRooms(rooms) {
      currentRooms = rooms;
      const container = document.getElementById('roomList');
      container.innerHTML = '';
      rooms.forEach((room, index) => {
        const div = document.createElement('div');
        div.className = 'room-item';
        div.innerHTML = `
          <button class="btn-danger" onclick="removeRoom(${index})">Ã—</button>
          <div class="room-label">ROOM ID</div>
          <div class="room-value">${room.id}</div>
          <div class="room-label">TAB NAME</div>
          <div class="room-value">${room.tabName}</div>
        `;
        container.appendChild(div);
      });
    }

    function addRoom() {
      const id = document.getElementById('newRoomId').value;
      const tab = document.getElementById('newTabName').value;
      if(!id || !tab) return;
      currentRooms.push({ id, tabName: tab });
      renderRooms(currentRooms);
      document.getElementById('newRoomId').value = '';
      document.getElementById('newTabName').value = '';
    }

    function removeRoom(index) {
      currentRooms.splice(index, 1);
      renderRooms(currentRooms);
    }

    // --- ä¿å­˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (GASå‘¼ã³å‡ºã—) ---
    function saveToken() {
      const val = document.getElementById('apiToken').value;
      google.script.run.withSuccessHandler(() => showStatus('tokenStatus', 'ä¿å­˜ã—ã¾ã—ãŸ')).saveApiToken(val);
    }

    function saveRooms() {
      google.script.run.withSuccessHandler(() => showStatus('roomStatus', 'åæ˜ ã—ã¾ã—ãŸ')).saveRoomSettings(currentRooms);
    }

    function saveSchedule() {
      // è¦‹ã›ã‹ã‘ã®ä¿å­˜å‡¦ç†ï¼ˆãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’å–å¾—ï¼‰
      const schedule = {
        morning: document.getElementById('scheduleMorning').checked,
        noon: document.getElementById('scheduleNoon').checked,
        evening: document.getElementById('scheduleEvening').checked
      };
      // â€»å®Ÿéš›ã«ã¯ã“ã“ã§GASã«ãƒˆãƒªã‚¬ãƒ¼è¨­å®šã‚’æŠ•ã’ã‚‹
      google.script.run.withSuccessHandler(() => showStatus('scheduleStatus', 'ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ')).saveSchedule(schedule); 
    }

    function runManual() {
      document.getElementById('runStatus').textContent = 'å®Ÿè¡Œä¸­...';
      google.script.run.withSuccessHandler((res) => {
        document.getElementById('runStatus').textContent = res;
      }).runFromSidebar();
    }

    function showStatus(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      setTimeout(() => el.textContent = '', 3000);
    }
  </script>
</body>
</html>